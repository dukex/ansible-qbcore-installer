---
# Deploy FiveM server data from Git

- name: Ensure server data folder exists
  file:
    path: "{{ server_data_folder }}"
    state: directory
    mode: "0755"
  tags:
    - config
    - deploy
    - deploy_data

- name: Generate SSH deploy key on server
  command: ssh-keygen -t ed25519 -C "fivem-deploy@{{ ansible_facts['hostname'] }}" -f {{ git_deploy_key_path }} -N ""
  args:
    creates: "{{ git_deploy_key_path }}"
  when: git_deploy_key | length == 0
  tags:
    - deploy
    - deploy_data

- name: Read generated public key
  slurp:
    src: "{{ git_deploy_key_path }}.pub"
  register: deploy_public_key
  when: git_deploy_key | length == 0
  tags:
    - deploy
    - deploy_data

- name: Write deploy key for private repo (optional)
  copy:
    content: "{{ git_deploy_key }}\n"
    dest: "{{ git_deploy_key_path }}"
    mode: "0600"
  when: git_deploy_key | length > 0
  no_log: true
  tags:
    - deploy
    - deploy_data

- name: Fix deploy key permissions and format
  file:
    path: "{{ git_deploy_key_path }}"
    mode: "0400"
    owner: "{{ ansible_user_id }}"
  when: git_deploy_key | length > 0
  tags:
    - deploy
    - deploy_data

- name: Check last deployed version
  stat:
    path: "{{ server_data_folder }}/.deployed_sha"
  register: deployed_sha_file
  tags:
    - resources
    - deploy
    - deploy_data

- name: Read last deployed SHA
  slurp:
    src: "{{ server_data_folder }}/.deployed_sha"
  register: last_deployed_sha
  when: deployed_sha_file.stat.exists
  tags:
    - resources
    - deploy
    - deploy_data

- name: Get remote SHA for requested revision
  command: git ls-remote {{ resources_git_url }} {{ revision }}
  register: remote_sha_result
  changed_when: false
  when: resources_git_url | length > 0
  environment:
    GIT_SSH_COMMAND: "ssh -i {{ git_deploy_key_path }} -o StrictHostKeyChecking=accept-new"
  tags:
    - resources
    - deploy
    - deploy_data

- name: Set remote SHA fact
  set_fact:
    remote_sha: "{{ remote_sha_result.stdout.split()[0] | default('') }}"
  when: remote_sha_result is defined and remote_sha_result.stdout | default('') | length > 0
  tags:
    - resources
    - deploy
    - deploy_data

- name: Set deployment needed fact
  set_fact:
    deployment_needed: "{{ not deployed_sha_file.stat.exists or (last_deployed_sha.content | default('') | b64decode | trim) != (remote_sha | default('')) }}"
  tags:
    - resources
    - deploy
    - deploy_data

- name: Create temporary file
  ansible.builtin.tempfile:
    state: directory
    suffix: temp
  register: tempdir
  when: deployment_needed
  tags:
    - resources
    - deploy
    - deploy_data

- name: Checkout or update server data repository
  git:
    repo: "{{ resources_git_url }}"
    dest: "{{ tempdir.path }}/checkout"
    version: "{{ revision }}"
    force: yes
    update: yes
    recursive: yes
    key_file: "{{ git_deploy_key_path }}"
    accept_hostkey: yes
    single_branch: yes
  when: resources_git_url | length > 0 and deployment_needed
  tags:
    - resources
    - deploy
    - deploy_data

- name: Backup existing server data resources
  copy:
    src: "{{ server_data_folder }}/resources"
    dest: "{{ tempdir.path }}/backup-resources"
    remote_src: yes
    owner: "{{ fivem_user }}"
    group: "{{ fivem_group }}"
  when: resources_git_url | length > 0 and deployment_needed
  tags:
    - resources
    - deploy
    - deploy_data

- name: Remove the old file
  file:
    path: "{{ server_data_folder }}/resources"
    state: absent
  when: deployment_needed
  tags:
    - resources
    - deploy
    - deploy_data

- name: Synchronize server data resources to server data folder
  copy:
    src: "{{ tempdir.path }}/checkout/resources"
    dest: "{{ server_data_folder }}"
    owner: "{{ fivem_user }}"
    group: "{{ fivem_group }}"
    remote_src: yes
  when: resources_git_url | length > 0 and deployment_needed
  tags:
    - resources
    - deploy
    - deploy_data

- name: Template ox.cfg to server data folder
  template:
    src: "../config/ox.cfg.j2"
    dest: "{{ server_data_folder }}/ox.cfg"
    mode: "0644"
  when: resources_git_url | length > 0 and deployment_needed
  tags:
    - config
    - deploy
    - deploy_data

- name: Template permissions.cfg to server data folder
  template:
    src: "../config/permissions.cfg.j2"
    dest: "{{ server_data_folder }}/permissions.cfg"
    mode: "0644"
  when: resources_git_url | length > 0 and deployment_needed
  tags:
    - config
    - deploy
    - deploy_data

- name: Template server.cfg to server data folder
  template:
    src: "../config/server.cfg.j2"
    dest: "{{ server_data_folder }}/server.cfg"
    mode: "0644"
  when: resources_git_url | length > 0 and deployment_needed
  tags:
    - config
    - deploy
    - deploy_data

- name: Template config.json
  template:
    src: "config.json.j2"
    dest: "{{ server_data_folder }}/../default/config.json"
    mode: "0644"
  when: resources_git_url | length > 0 and deployment_needed
  tags:
    - config
    - deploy
    - deploy_data

- name: Remove temporary directory
  file:
    path: "{{ tempdir.path }}"
    state: absent
  when: resources_git_url | length > 0 and deployment_needed
  tags:
    - resources
    - deploy
    - deploy_data

- name: Remove cache directory
  file:
    path: "{{ server_data_folder }}/cache"
    state: absent
  when: resources_git_url | length > 0 and deployment_needed
  tags:
    - resources
    - deploy
    - deploy_data

- name: Logo file deployment
  copy:
    src: "../config/logo.png"
    dest: "{{ server_data_folder }}/logo.png"
    mode: "0644"
    owner: "{{ fivem_user }}"
    group: "{{ fivem_group }}"
  when: resources_git_url | length > 0 and deployment_needed
  tags:
    - config
    - deploy
    - deploy_data

- name: Ensure ownership of FiveM server path
  become: true
  file:
    path: "{{ fivem_server_path }}"
    state: directory
    owner: "{{ fivem_user }}"
    group: "{{ fivem_group }}"
    recurse: yes
    mode: "0755"
  when: deployment_needed
  tags:
    - resources
    - deploy
    - deploy_data
    - config

- name: Save deployed SHA
  copy:
    content: "{{ remote_sha }}"
    dest: "{{ server_data_folder }}/.deployed_sha"
    mode: "0644"
    owner: "{{ fivem_user }}"
    group: "{{ fivem_group }}"
  when: deployment_needed and remote_sha is defined
  tags:
    - resources
    - deploy
    - deploy_data
